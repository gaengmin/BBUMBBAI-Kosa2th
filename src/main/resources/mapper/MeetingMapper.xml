<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kosa.project.repository.mapper.MeetingMapper">

    <!-- UserMeetingDto 매핑 -->
    <resultMap id="UserMeetingDtoResultMap" type="org.kosa.project.service.dto.UserMeetingDto">
        <id property="userMeetingId" column="user_meeting_id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="meetingId" column="meeting_id"/>
        <result property="userType" column="user_type"/>
    </resultMap>

    <!-- MeetingDetailDto 매핑 -->
    <resultMap id="MeetingDetailDtoResultMap" type="org.kosa.project.service.dto.MeetingDetailDto">
        <id property="meetingId" column="meeting_id"/>
        <result property="userId" column="user_id"/>
        <result property="regionId" column="region_id"/>
        <result property="category" column="category"/>
        <result property="subject" column="subject"/>
        <result property="context" column="context"/>
        <result property="totalMember" column="total_member"/>
        <result property="presentMember" column="present_member"/>
        <result property="fileName" column="file_name"/>
        <result property="meetingStatus" column="status"/>
        <result property="regDate" column="reg_dt"/>
        <collection property="userMeetingDto" ofType="org.kosa.project.service.dto.UserMeetingDto"
                    resultMap="UserMeetingDtoResultMap"/>
    </resultMap>


    <insert id="save" parameterType="org.kosa.project.controller.MeetingRegisterRequest" useGeneratedKeys="true">
        INSERT INTO MEETING (user_id, category, subject, context, total_member, file_name)
        VALUES (#{userId}, #{category}, #{subject}, #{context}, #{totalMember}, #{fileUploadUrl})
    </insert>


    <select id="meetingList" resultMap="MeetingDetailDtoResultMap">
        select *
        from (select meeting_id,
        user_id,
        category,
        subject,
        context,
        readcount,
        file_name,
        total_member,
        present_member,
        status,
        reg_dt,
        row_number() over (order by meeting_id desc, reg_dt desc) as rnum
        from meeting
        where meeting_id > 0
        <if test="condition.content != null and condition.content !=''">
            <if test='condition.searchType == "all"'>
                and subject like '%' || #{condition.content} || '%' or context like '%' || #{condition.content} || '%'
            </if>
            <if test='condition.searchType == "subject"' >
                and subject like '%' || #{condition.content} || '%'
            </if>
            <if test='condition.searchType == "content"'>
                and context like '%' || #{condition.content} || '%'
            </if>
        </if>
        )
        where rnum between ((#{condition.page} - 1) * #{pageSize}) + 1 and #{condition.page} * #{pageSize}
    </select>

    <select id="countMeetings" resultType="int">
        SELECT COUNT(*)
        FROM meeting
    </select>

    <insert id="attendanceSave" parameterType="org.kosa.project.service.dto.UserMeetingDto">
        insert into user_meeting (user_id, meeting_id, user_type)
        values (#{userId}, #{meetingId}, #{userType})
    </insert>

    <select id="getUserMeetingCheck" parameterType="org.kosa.project.service.dto.UserMeetingCheckDto"
            resultType="String">
        select user_type
        from user_meeting
        where user_id = #{userId}
          and meeting_id = #{meetingId}
    </select>

    <!-- 쿼리 -->
    <select id="meetingDetails" parameterType="long" resultMap="MeetingDetailDtoResultMap">
        SELECT m.meeting_id  as meeting_id,
               um.user_id,
               m.region_id,
               m.category,
               m.subject,
               m.context,
               m.total_member,
               m.present_member,
               m.file_name,
               m.status,
               m.reg_dt,
               um.user_meeting_id,
               um.user_id,
               u.user_name,
               um.meeting_id as um_meeting_id,
               um.user_type
        FROM meeting m
                 LEFT JOIN user_meeting um ON m.meeting_id = um.meeting_id
                 LEFT JOIN users u ON um.user_id = u.user_id
        WHERE m.meeting_id = #{meetingId}
    </select>

</mapper>